#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ .env.prod –≤ BASE64 —Ñ–æ—Ä–º–∞—Ç
# –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ GitHub Secrets

ENV_FILE=${1:-".env.prod"}

if [ ! -f "$ENV_FILE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª $ENV_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª $ENV_FILE –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.prod.example"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞
echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º..."
# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ø–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
cp "$ENV_FILE" "${ENV_FILE}.orig"

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å —Ñ–æ—Ä–º–∞—Ç–æ–º
echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å —Ñ–æ—Ä–º–∞—Ç–æ–º..."
sed -i 's/ *= */=/g' "$ENV_FILE"  # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ =
sed -i 's/`/"/g' "$ENV_FILE"      # –ó–∞–º–µ–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –Ω–∞ –¥–≤–æ–π–Ω—ã–µ
sed -i "s/'/\"/g" "$ENV_FILE"     # –ó–∞–º–µ–Ω—è–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –Ω–∞ –¥–≤–æ–π–Ω—ã–µ

# –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
echo "üîß –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ –æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫..."
CLEANED_FILE="${ENV_FILE}.cleaned"
grep -v '^#' "$ENV_FILE" | grep -v '^$' > "$CLEANED_FILE"

echo "üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö:"
echo "- –†–∞–∑–º–µ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: $(wc -c < ${ENV_FILE}.orig) –±–∞–π—Ç"
echo "- –†–∞–∑–º–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: $(wc -c < $ENV_FILE) –±–∞–π—Ç"
echo "- –†–∞–∑–º–µ—Ä –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: $(wc -c < $CLEANED_FILE) –±–∞–π—Ç"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ –æ—à–∏–±–∫–∏
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞..."
ERROR_FOUND=0
while IFS= read -r line || [[ -n "$line" ]]; do
    if ! [[ "$line" =~ ^[A-Za-z0-9_]+=.* ]]; then
        echo "‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Å—Ç—Ä–æ–∫–µ: $line"
        ERROR_FOUND=1
    fi
done < "$CLEANED_FILE"

if [ $ERROR_FOUND -eq 1 ]; then
    echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ñ–∞–π–ª–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º."
else
    echo "‚úÖ –§–∞–π–ª –ø—Ä–æ–≤–µ—Ä–µ–Ω, –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
fi

# –ö–æ–¥–∏—Ä—É–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ BASE64
encoded=$(base64 -i "$CLEANED_FILE")

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
rm "$CLEANED_FILE"

echo "üîê –§–∞–π–ª $ENV_FILE –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ BASE64:"
echo
echo "$encoded"
echo
echo "‚úÖ –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ GitHub Secrets —Å –∏–º–µ–Ω–µ–º ENV_FILE_BASE64"
