#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ .env.prod –≤ BASE64 —Ñ–æ—Ä–º–∞—Ç
# –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ GitHub Secrets

ENV_FILE=${1:-".env.prod"}

if [ ! -f "$ENV_FILE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª $ENV_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª $ENV_FILE –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.prod.example"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ $ENV_FILE –ø–µ—Ä–µ–¥ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:"
./check_env_file.sh "$ENV_FILE"

# –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
CLEANED_FILE="${ENV_FILE}.cleaned"
grep -E -v "^#|^$" "$ENV_FILE" > "$CLEANED_FILE"

echo "üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ—á–∏—â–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ:"
echo "–†–∞–∑–º–µ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: $(wc -c < $ENV_FILE) –±–∞–π—Ç"
echo "–†–∞–∑–º–µ—Ä –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: $(wc -c < $CLEANED_FILE) –±–∞–π—Ç"

# –ö–æ–¥–∏—Ä—É–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ BASE64
encoded=$(base64 -i "$CLEANED_FILE")

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm "$CLEANED_FILE"

echo "üîê –§–∞–π–ª $ENV_FILE –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ BASE64:"
echo
echo "$encoded"
echo
echo "‚úÖ –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ GitHub Secrets —Å –∏–º–µ–Ω–µ–º ENV_FILE_BASE64"
