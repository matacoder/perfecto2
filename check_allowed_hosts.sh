#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ALLOWED_HOSTS

DOMAIN=${1:-"perf.mtkv.ru"}
ENV_FILE=${2:-".env.prod"}

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ALLOWED_HOSTS –¥–ª—è –¥–æ–º–µ–Ω–∞ ${DOMAIN}"
echo "======================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª .env.prod
if [ -f "${ENV_FILE}" ]; then
    echo "‚úÖ –§–∞–π–ª ${ENV_FILE} –Ω–∞–π–¥–µ–Ω"
    
    # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å ALLOWED_HOSTS
    if grep -q "^ALLOWED_HOSTS=" "${ENV_FILE}"; then
        ALLOWED_HOSTS=$(grep "^ALLOWED_HOSTS=" "${ENV_FILE}" | cut -d= -f2)
        echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ALLOWED_HOSTS –Ω–∞–π–¥–µ–Ω–∞: ${ALLOWED_HOSTS}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–æ–º–µ–Ω–∞ –≤ ALLOWED_HOSTS
        if [[ "${ALLOWED_HOSTS}" == *"${DOMAIN}"* ]]; then
            echo "‚úÖ –î–æ–º–µ–Ω ${DOMAIN} –Ω–∞–π–¥–µ–Ω –≤ ALLOWED_HOSTS"
        else
            echo "‚ùå –î–æ–º–µ–Ω ${DOMAIN} –ù–ï –Ω–∞–π–¥–µ–Ω –≤ ALLOWED_HOSTS!"
            echo "üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤—å—Ç–µ ${DOMAIN} –≤ ALLOWED_HOSTS –≤ —Ñ–∞–π–ª–µ ${ENV_FILE}"
        fi
    else
        echo "‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ALLOWED_HOSTS –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ ${ENV_FILE}"
        echo "üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É 'ALLOWED_HOSTS=${DOMAIN},localhost,127.0.0.1' –≤ —Ñ–∞–π–ª ${ENV_FILE}"
    fi
else
    echo "‚ùå –§–∞–π–ª ${ENV_FILE} –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -n "${ALLOWED_HOSTS}" ]; then
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è ALLOWED_HOSTS —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${ALLOWED_HOSTS}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–æ–º–µ–Ω–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if [[ "${ALLOWED_HOSTS}" == *"${DOMAIN}"* ]]; then
        echo "‚úÖ –î–æ–º–µ–Ω ${DOMAIN} –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è ALLOWED_HOSTS"
    else
        echo "‚ùå –î–æ–º–µ–Ω ${DOMAIN} –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è ALLOWED_HOSTS!"
    fi
else
    echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è ALLOWED_HOSTS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
fi

echo "======================================================="
echo "üìù –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ ${ENV_FILE} –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ 'ALLOWED_HOSTS=${DOMAIN},localhost,127.0.0.1'"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ Docker Compose –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
echo "3. –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ GitHub Actions, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª .env.prod —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ALLOWED_HOSTS"
echo "4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: docker compose restart"
